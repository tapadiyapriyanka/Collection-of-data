USE [LivePCM]
GO
/****** Object:  StoredProcedure [dbo].[importviews_pcm]    Script Date: 5/9/2018 11:51:55 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--vw_rms_sc_day_in_out,VW_RMS_BOD_SEC
--exec  [importviews_pcm] '', ''
ALTER proc [dbo].[importviews_pcm] 
@viewName varchar(1000),
@date varchar(10)
as

set nocount on
EXEC sp_configure 'show advanced options', 1  
RECONFIGURE WITH OVERRIDE  
EXEC sp_configure 'xp_cmdshell', 1  
	RECONFIGURE WITH OVERRIDE  
EXEC sp_configure 'show advanced options', 0  

declare @msg  as varchar(100)
if @viewName ='' or @viewName ='cross_mrg'
begin
	delete LIVE_MESSAGETAB
	where MESSAGEHEADER like 'View Not Work %'

	BEGIN TRY
		exec [BASKETSCRIPIMPORT] 
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'BASKET SCRIP IMPORT','',@msg
	END CATCH



	create table #crmrg
	(
		con varchar(100)
	)
	insert into #crmrg
	EXEC xp_cmdshell 'dir D:\TECHEXCEL\ExchangeMargin\cross_mrg.xls'

	delete LIVE_MESSAGETAB
	where MESSAGEHEADER like '%CROSS MARGIN%'

	DECLARE @D111 AS VARCHAR(100)
	select @D111= 'CROSS MARGIN FILE '+LEFT(CON,20) 
	from #crmrg
	where con like '%cross_mrg%'

	EXEC Inst_Message @D111,'Y',''
end
ELSE
begin 
	delete LIVE_MESSAGETAB
	where MESSAGEHEADER like 'View Not Work %'+@viewName+'%'
END

DECLARE @Q1 VARCHAR(8000)
DECLARE @Q2 VARCHAR(8000)
DECLARE @Q3 VARCHAR(8000)
DECLARE @Q4 VARCHAR(8000)
DECLARE @Q5 VARCHAR(8000)
DECLARE @Q6 VARCHAR(8000)
DECLARE @Q7 VARCHAR(8000)
DECLARE @Q8 VARCHAR(8000)
DECLARE @Q9 VARCHAR(8000)
DECLARE @Q10 VARCHAR(8000)
DECLARE @Q11 VARCHAR(8000)
DECLARE @Q12 VARCHAR(8000)
DECLARE @Q13 VARCHAR(8000)
DECLARE @Q14 VARCHAR(8000)
DECLARE @Q15 VARCHAR(8000)
DECLARE @Q16 VARCHAR(8000)
DECLARE @Q17 VARCHAR(8000)
DECLARE @Q18 VARCHAR(8000)
declare @BODdate as datetime
SELECT @BODdate =MAX(PDATE )
FROM pcm.dbo.PROCESS 
WHERE PTYPE ='BOD' 
AND PROCESSACTIVE ='Y'
AND COMPANY_CODE ='NSE_FNO'


BEGIN TRY
	SELECT @date=CONVERT(VARCHAR(10),MAX(TRADE_DATE),103) 
	FROM PCM.DBO.TRADE1_S
	WHERE CONVERT(VARCHAR(10),GETDATE(),103) !=CONVERT(VARCHAR(10),TRADE_DATE,103)
END TRY
BEGIN CATCH
	SET @MSG  = ERROR_MESSAGE() 
	EXEC Inst_Message 'TRADE1_S','',@msg
END CATCH


if (@viewName='RMS_CM_PRICE' OR @viewName ='')
begin
	BEGIN TRY

	select @date
		TRUNCATE TABLE RMS_CM_PRICE
		INSERT INTO [LivePCM].[dbo].RMS_CM_PRICE
		( TRDDATE,SYMBOL,MKTTYPE,OPEN_PRICE,HIGH_PRICE,LOW_PRICE,CLOSE_PRICE,SHARE_TRADE,SHARE_VALUE)
		SELECT  TRDDATE,SYMBOL,MKTTYPE,OPEN_PRICE,HIGH_PRICE,LOW_PRICE,CLOSE_PRICE,SHARE_TRADE,SHARe_VALUE 
		FROM PCM.DBO.RMS_CM_PRICE
		WHERE TRDDATE =  CONVERT(datetime,@date,103) 

		Truncate table TEMP_NSE_BHAV
		INSERT	[TEMP_NSE_BHAV]
		(
			SCRIP_SYMBOL,Scrip_type,SCRIP_CLOSING_PRICE,TotTrdqty,TotTrdval,Timestamp
		)	
		SELECT SYMBOL,mkttype,Close_price,Share_Trade,Share_value,getdate() FROM RMS_CM_PRICE

		UPDATE TEMP_NSE_BHAV
		SET SCRIP_SYMBOL = RTRIM(SCRIP_SYMBOL)+'-'+RTRIM(SCRIP_TYPE)
		WHERE SCRIP_TYPE NOT IN ('EQ','BE') 		

		DELETE LIVE_BackPrice
		WHERE exchange ='CASH' 

		INSERT	LIVE_BackPrice
		(
			exchange, SCRIP_SYMBOL, SCRIP_NAME, isin, Price, FILEDATE, ImportTime
		)	
		SELECT
		DISTINCT 
		'CASH',A.SCRIP_SYMBOL,SCRIP_SYMBOL, ISIN, SCRIP_CLOSING_PRICE,GETDATE(),GETDATE()
		FROM
		TEMP_NSE_BHAV A
		WHERE	A.SCRIP_TYPE	IN	('EQ','BE','E2','E1','N1','P1','N2','N3','N4','N5')
		
			--DELETE [SCRIP_AVGQTY]
			--declare @FROMDATE as varchar(1000)
			--declare @TODATE as varchar(1000)
			--SET @FROMDATE  =convert(VARCHAR(10),GETDATE()-180 ,102)

			--INSERT INTO [LivePCM].[dbo].[SCRIP_AVGQTY]
			--		   ([Type]
			--		   ,[ScripSymbol]
			--		   ,[Maxdata]
			--		   ,[MinDate]
			--		   ,[AVGQTY]
			--		   ,[NOOFDAY])
			--SELECT  '6',SYMBOL,MAX(TRDDATE) MAXDATA,MIN(TRDDATE) MIDATE,CAST (SUM(SHARE_TRADE)/COUNT(TRDDATE) AS INT) AVGTRADED,COUNT(TRDDATE) NOOFDATE  
			--FROM PCM.DBO.RMS_CM_PRICE where TRDDATE >= CONVERT(DATETIME,@FROMDATE,103)
			--GROUP BY SYMBOL
			

			--SET @FROMDATE  =convert(VARCHAR(10),GETDATE()-90 ,102)
			--SET @Q11 = 'SELECT ''3'',*  FROM OPENQUERY(OracleServer,''SELECT  SYMBOL,MAX(TRDDATE) MAXDATA,MIN(TRDDATE) MIDATE,CAST (SUM(SHARE_TRADE)/COUNT(TRDDATE) AS INT) AVGTRADED,COUNT(TRDDATE) NOOFDATE  FROM VW_RMS_CM_PRICE where TRDDATE >= '''''+@FROMDATE+''''' GROUP BY SYMBOL'')'
			--PRINT @Q11
			--INSERT INTO [LivePCM].[dbo].[SCRIP_AVGQTY]
			--		   ([Type]
			--		   ,[ScripSymbol]
			--		   ,[Maxdata]
			--		   ,[MinDate]
			--		   ,[AVGQTY]
			--		   ,[NOOFDAY])
			--SELECT  '3',SYMBOL,MAX(TRDDATE) MAXDATA,MIN(TRDDATE) MIDATE,CAST (SUM(SHARE_TRADE)/COUNT(TRDDATE) AS INT) AVGTRADED,COUNT(TRDDATE) NOOFDATE  
			--FROM PCM.DBO.RMS_CM_PRICE where TRDDATE >= CONVERT(DATETIME,@FROMDATE,103)
			--GROUP BY SYMBOL


			--SET @FROMDATE  =convert(VARCHAR(10),GETDATE()-30 ,103)
			--SET @Q11 = 'SELECT ''1'',*  FROM OPENQUERY(OracleServer,''SELECT  SYMBOL,MAX(TRDDATE) MAXDATA,MIN(TRDDATE) MIDATE,CAST (SUM(SHARE_TRADE)/COUNT(TRDDATE) AS INT) AVGTRADED,COUNT(TRDDATE) NOOFDATE  FROM VW_RMS_CM_PRICE where TRDDATE >= '''''+@FROMDATE+''''' GROUP BY SYMBOL'')'
			--PRINT @Q11
			--INSERT INTO [LivePCM].[dbo].[SCRIP_AVGQTY]
			--		   ([Type]
			--		   ,[ScripSymbol]
			--		   ,[Maxdata]
			--		   ,[MinDate]
			--		   ,[AVGQTY]
			--		   ,[NOOFDAY])
			--SELECT  '1',SYMBOL,MAX(TRDDATE) MAXDATA,MIN(TRDDATE) MIDATE,CAST (SUM(SHARE_TRADE)/COUNT(TRDDATE) AS INT) AVGTRADED,COUNT(TRDDATE) NOOFDATE  
			--FROM PCM.DBO.RMS_CM_PRICE where TRDDATE >= CONVERT(DATETIME,@FROMDATE,103)
			--GROUP BY SYMBOL

	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'RMS_CM_PRICE','',@msg
		print @msg
	END CATCH


end 

select 1
if (@viewName='TMOPL' OR @viewName ='')
begin
	BEGIN TRY 
		TRUNCATE TABLE tmopl


		
		INSERT INTO [LivePCM].[dbo].tmopl
		( EFF_POS_LIMIT,SCRIP_NAME)
		SELECT EFF_POS_LIMIT,SCRIP_NAME
		FROM PCM.[DBO].TMOPL
		WHERE DATE1 IN ( SELECT MAX(DATE1)FROM PCM.[DBO].TMOPL )				 

	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'tmopl','',@msg
	END CATCH
end 

if (@viewName='tmfpl' OR @viewName ='')
begin
	BEGIN TRY 
		TRUNCATE TABLE tmfpl

		INSERT INTO [LivePCM].[dbo].tmfpl
		( EFF_FUT_LMT,SCRIP_NAME)
		SELECT EFF_FUT_LMT,SCRIP_NAME
		FROM PCM.[DBO].tmfpl
		WHERE DATE1 IN ( SELECT MAX(DATE1)FROM PCM.[DBO].tmfpl )				 

	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'tmfpl','',@msg
	END CATCH
end 

--if (@viewName='MWP' OR @viewName ='')
--begin
--	BEGIN TRY 
--		TRUNCATE TABLE MWP

--		INSERT INTO [LivePCM].[dbo].MWP
--		( QTY,SYMBOL)
--		SELECT QTY,SYMBOL
--		FROM PCM.[DBO].MWP
--		WHERE DATE1 IN ( SELECT MAX(DATE1)FROM PCM.[DBO].MWP )

--	END TRY
--	BEGIN CATCH
--		SET @MSG  = ERROR_MESSAGE() 
--		EXEC Inst_Message 'MWP','',@msg
--	END CATCH
--end 

if (@viewName='MWP1' OR @viewName ='')
begin
	BEGIN TRY 
		TRUNCATE TABLE MWP1

		INSERT INTO [LivePCM].[dbo].MWP1
		( QTY,SYMBOL)
		SELECT QTY,SYMBOL
		FROM PCM.[DBO].MWP1
		WHERE DATE1 IN ( SELECT MAX(DATE1)FROM PCM.[DBO].MWP1 )

	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'MWP1','',@msg
	END CATCH
end 

if (@viewName='NPH1' OR @viewName ='')
begin
	BEGIN TRY 
		TRUNCATE TABLE NPH1

		INSERT INTO [LivePCM].[dbo].NPH1
		( QTY,SYMBOL)
		SELECT QTY,SYMBOL
		FROM PCM.[DBO].NPH1
		WHERE DATE1 IN ( SELECT MAX(DATE1)FROM PCM.[DBO].NPH1 )

	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'NPH1','',@msg
	END CATCH
end 





if (@viewName='RMS_SCRIP_HAIRCUT' OR @viewName ='')
begin
	BEGIN TRY 
		SET @Q10 = 'SELECT *  FROM OPENQUERY(OracleServer,''SELECT   app,EXCH,BSKTCODE,BSKTDESC,SCRIPCODE,ACTUALHCUT   FROM VW_RMS_SCRIP_BSKT'')'
		PRINT @Q10

		TRUNCATE TABLE RMS_SCRIP_BSKT
		
		INSERT INTO [LivePCM].[dbo].RMS_SCRIP_BSKT
		( app,EXCH,BSKTCODE,BSKTDESC,SCRIPTCODE,ACTUALHCUT)
		SELECT app,EXCH,BSKTCODE,BSKTDESC,SCRIPTCODE,ACTUALHCUT 
		FROM PCM.DBO.RMS_SCRIP_BSKT A,COMPANY_MASTER  B
		WHERE A.COCD = B.COMPANY_CODE
		 

	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'RMS_SCRIP_BSKT','',@msg
	END CATCH
end 

if (@viewName='RMS_SEC_UNDER_BAN' OR @viewName ='')
begin
	BEGIN TRY
		DECLARE @DATE1 AS VARCHAR(10)
		SET @DATE1 =CONVERT(VARCHAR(10),GETDATE(),103)

		SET @Q18 = 'SELECT *  FROM OPENQUERY(OracleServer,''Select APP,EXCH,TRDDATE,SYMBOL from VW_RMS_SEC_UNDER_BAN  WHERE TRDDATE = '''''+@DATE1+''''''')'
		PRINT @Q18

		TRUNCATE TABLE RMS_SEC_UNDER_BAN

		INSERT INTO [LivePCM].[dbo].RMS_SEC_UNDER_BAN
		(APP,EXCHANGE,TRDDATE,SYMBOL)
		SELECT 'FNO','NSE',DATE,SCRIP_SYMBOL  FROM PCM.DBO.RMS_SEC_UNDER_BAN
		WHERE CONVERT(VARCHAR(10),DATE,103) =@DATE1 
	DECLARE @RESULT VARCHAR(500)

	SET @RESULT = ''

	-- STRING TOGETHER ALL ITEMS WITH A COMMA BETWEEN
	SELECT @RESULT = CASE WHEN @RESULT = '' THEN SYMBOL ELSE @RESULT + ',' + SYMBOL END FROM RMS_SEC_UNDER_BAN 

	SELECT @RESULT

	UPDATE M_USER_SETTINGS
	SET FOBANDSCRIP  = @RESULT
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'RMS_SEC_UNDER_BAN','',@msg
	END CATCH
end 

if (@viewName='VW_RMS_MRGN_INTRDAY' OR @viewName ='')
begin
	delete VW_RMS_MRGN_INTRDAY
	insert into VW_RMS_MRGN_INTRDAY
	(APP, EXCH, TRDDATE, TMCODE, TMSNAME, MTM_AMT, AMTM_AMT, TOT_MRGN, TOT_COLL, INTRA_FUNDING)
	SELECT B.APP, B.EXCH, TRDDATE, TMCODE, TMSNAME, MTM_AMT, AMTM_AMT, TOT_MRGN, TOT_COLL, INTRA_FUNDING
	FROM PCM.DBO.VW_RMS_MRGN_INTRDAY a,COMPANY_MASTER B
	WHERE A.COCD = B.COMPANY_CODE
	AND CONVERT(VARCHAR(10),TRDDATE,103) =@DATE1 
end


if (@viewName='RMS_GROUP_MAPPING' OR @viewName ='')
begin
	BEGIN TRY
		TRUNCATE TABLE RMS_GROUP_MAPPING
		INSERT INTO [LivePCM].[dbo].RMS_GROUP_MAPPING
		(GROUPCODE, FNO_NSE_TMCODE, FNO_NSE_MFTMCODE, FNO_BSE_TMCODE, FNO_BSE_MFTMCODE, FNO_MSX_TMCODE, FNO_MSX_MFTMCODE, 
                      CF_NSE_TMCODE, CF_NSE_MFTMCODE, F_MSX_TMCODE, CF_MSX_MFTMCODE, CF_USE_TMCODE, CF_USE_MFTMCODE, NCD_TMCODE, NCD_MFTMCODE, 
                      MCX_TMCODE, MCX_MFTMCODE)
		SELECT GROUPCODE, FNO_NSE_TMCODE, FNO_NSE_MFTMCODE, FNO_BSE_TMCODE, FNO_BSE_MFTMCODE, FNO_MSX_TMCODE, FNO_MSX_MFTMCODE, 
					CF_NSE_TMCODE, CF_NSE_MFTMCODE, F_MSX_TMCODE, CF_MSX_MFTMCODE, CF_USE_TMCODE, CF_USE_MFTMCODE, NCD_TMCODE, NCD_MFTMCODE, 
					MCX_TMCODE, MCX_MFTMCODE
		FROM PCM.DBO.RMS_GROUP_MAPPING
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'RMS_GROUP_MAPPING','',@msg
	END CATCH
end 

if (@viewName='RMS_HCUT_EXCH' OR @viewName ='')
begin
	BEGIN TRY
		SET @Q18 = 'SELECT *  FROM OPENQUERY(OracleServer,''Select APP, EXCH, TRDDATE, SYMBOL, SERIES, MRGN_RT, ISIN, 
                      CLOSE_PRICE from VW_RMS_HCUT_EXCH  WHERE TRDDATE = '''''+@DATE+''''''' )'
		PRINT @Q18

		TRUNCATE TABLE RMS_HCUT_EXCH

		INSERT INTO [LivePCM].[dbo].RMS_HCUT_EXCH
		(APP, EXCH, TRDDATE, SYMBOL, SERIES, MRGN_RT, ISIN,  CLOSE_PRICE)
		SELECT APP, EXCH, TRDDATE, SYMBOL, SERIES, MRGN_RT, ISIN,  CLOSE_PRICE
		FROM PCM.DBO.RMS_HCUT_EXCH
		WHERE TRDDATE in(select max(TRDDATE) from PCM.DBO.RMS_HCUT_EXCH ) 
		
		TRUNCATE TABLE RMS_HCUT
		INSERT INTO RMS_HCUT
		(TRDDATE, SYMBOL, SERIES, HCUT)		
		SELECT     TRDDATE, SYMBOL, SERIES, MRGN_RT
		FROM         RMS_HCUT_EXCH

	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'RMS_HCUT_EXCH','',@msg
	END CATCH


end 

if (@viewName='BRANCH_MASTER' OR @viewName ='')
begin
	BEGIN TRY
		
		TRUNCATE TABLE RMS_BRANCH

		INSERT INTO [LivePCM].[dbo].RMS_BRANCH
		(FO_BRCH_CODE, FO_BRCH_NAME, FO_BRCH_PHONE1, FO_BRCH_PHONE2, FO_BRCH_CONTACT_PER1, FO_BRCH_CONTACT_PER2,
		FO_BRCH_EMAIL_ADDR,FO_BRCH_MOBILE)
		SELECT BRANCH_CODE,BRANCH_NAME,NULL,NULL,NULL,NULL,NULL,NULL
		FROM PCM.DBO.BRANCH_MASTER

	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'BRANCH_MASTER','',@msg
	END CATCH


end 


if (@viewName='VW_RMS_LIVE_LIMIT' OR @viewName ='')
begin


	delete LIVE_MESSAGETAB
	from LIVE_MESSAGETAB(nolock)
	where MESSAGEHEADER like 'View Not Work %RMS_BOD_LIMIT%'
	BEGIN TRY 
		declare @d_1 as numeric(30)
		declare @d_11 as numeric(30)



		delete RMS_BOD_LIMIT_act
		INSERT INTO [LivePCM].[dbo].RMS_BOD_LIMIT_act
		([APP],[EXCHANGE],[TRADEDATE],[TMCODE],[LIMIT])
		SELECT  
			C.APP,C.EXCH,A.TRADEDATE,A.TMCODE,A.LIMIT 
		FROM PCM.DBO.RMS_BOD_LIMIT A,(SELECT TMCODE,COCD,MAX(ROWID) ROWID FROM  PCM.DBO.RMS_BOD_LIMIT GROUP BY COCD,TMCODE ) B,COMPANY_MASTER C
		WHERE A.ROWID =  B.ROWID
		--AND  CONVERT(VARCHAR(10),TRADEDATE,103) =@DATE1 
		AND B.COCD = C.COMPANY_CODE
		SELECT @d_1= SUM(cast([LIMIT] as numeric(30,2)))
		FROM RMS_BOD_LIMIT_act
		 
		DELETE RMS_BOD_LIMIT 
		FROM RMS_BOD_LIMIT Y
		WHERE TMCODE NOT IN(SELECT TMCODE FROM RMS_BOD_LIMIT_act X WHERE X.APP = Y.APP AND X.EXCHANGE = Y.EXCHANGE)

		update RMS_BOD_LIMIT
		set limit = b.limit
		FROM RMS_BOD_LIMIT A,RMS_BOD_LIMIT_act B
		where a.app = b.app
		and a.EXCHANGE = b.EXCHANGE
		and a.tmcode = b.tmcode


		delete RMS_BOD_LIMIT_act 
		FROM RMS_BOD_LIMIT_act A, RMS_BOD_LIMIT B
		where a.app = b.app
		and a.EXCHANGE = b.EXCHANGE
		and a.tmcode = b.tmcode

		insert into RMS_BOD_LIMIT
		(APP, EXCHANGE, BRANCH, TRADEDATE, TMCODE, TMSCODE, LIMIT)
		SELECT     APP, EXCHANGE, BRANCH, TRADEDATE, TMCODE, TMSCODE, LIMIT
		FROM         RMS_BOD_LIMIT_act

		SELECT @d_11=SUM(cast([LIMIT] as numeric(30,2)))
		FROM RMS_BOD_LIMIT_act

		if @d_11 != @d_1
		begin
				EXEC Inst_Message 'RMS_BOD_LIMIT','',@msg
		end
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'RMS_BOD_LIMIT','',@msg
	END CATCH
end 



if (@viewName='VW_RMS_ENTRY_DTLS' OR @viewName ='')
begin
	BEGIN TRY 
		
		SELECT *  INTO #RMS_ENTRY_DTLS
		FROM RMS_ENTRY_DTLS WHERE 1=2

		TRUNCATE TABLE #RMS_ENTRY_DTLS
		INSERT INTO #RMS_ENTRY_DTLS
		([APP],[EXCH],[TMCODE],[TRDDATE],ADOCAMT,INTRAAMT)
		SELECT  APP,EXCH,TMCODE,TRDDATE,ADOCAMT,INTRAAMT 
		FROM PCM.DBO.RMS_ENTRY_DTLS  A,COMPANY_MASTER B
		WHERE A.COCD = B.COMPANY_ADDRESS
		AND TRDDATE =@BODdate
		AND ISNULL(Checker,'Y') ='Y'


		declare @d as numeric(30)
		declare @d1 as numeric(30)
		SELECT @d= SUM(CAST(ADOCAMT AS NUMERIC(30)))+SUM(CAST(INTRAAMT AS NUMERIC(30)))
		FROM #RMS_ENTRY_DTLS


		DELETE RMS_ENTRY_DTLS
		from RMS_ENTRY_DTLS y
		WHERE TMCODE NOT IN(SELECT TMCODE FROM #RMS_ENTRY_DTLS X WHERE X.APP = Y.APP AND X.EXCH = Y.EXCH)

		update RMS_ENTRY_DTLS
		set ADOCAMT = b.ADOCAMT , INTRAAMT = b.INTRAAMT
		FROM RMS_ENTRY_DTLS A,#RMS_ENTRY_DTLS B
		where a.app = b.app
		and a.EXCH = b.EXCH
		and a.tmcode = b.tmcode

		delete #RMS_ENTRY_DTLS 
		FROM #RMS_ENTRY_DTLS A, RMS_ENTRY_DTLS B
		where a.app = b.app
		and a.EXCH = b.EXCH
		and a.tmcode = b.tmcode

		insert into RMS_ENTRY_DTLS
		(APP, EXCH, BRANCH, REGIONCODE, GROUPCODE, TMCODE, TRDDATE, ADOCAMT, INTRAAMT)
		SELECT     APP, EXCH, BRANCH, REGIONCODE, GROUPCODE, TMCODE, TRDDATE, ADOCAMT, INTRAAMT
		FROM         #RMS_ENTRY_DTLS order by TMCODE

		SELECT @d1= SUM(CAST(ADOCAMT AS NUMERIC(30)))+SUM(CAST(INTRAAMT AS NUMERIC(30)))
		FROM RMS_ENTRY_DTLS
		if @d1 != @d
		begin
				EXEC Inst_Message 'RMS_ENTRY_DTLS','',@msg
		end
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'VW_RMS_ENTRY_DTLS','',@msg
	END CATCH
end 

--if (@viewName='vw_rms_mf_hcut' OR @viewName ='')
--begin
--	BEGIN TRY 
--		SET @Q13 = 'SELECT *  FROM OPENQUERY(OracleServer,''SELECT TRDDATE,SYMBOL,ISIN,RATE FROM vw_rms_mf_hcut  WHERE TRDDATE = '''''+@DATE+''''''')'
--		PRINT @Q13

--		TRUNCATE TABLE RMS_MF_HCUT

--		INSERT INTO [LivePCM].[dbo].RMS_MF_HCUT
--		( TRDDATE,SYMBOL,isin,RATE )
--		EXEC (@Q13)
--	END TRY
--	BEGIN CATCH
--		SET @MSG  = ERROR_MESSAGE() 
--		EXEC Inst_Message 'vw_rms_mf_hcut','',@msg
--	END CATCH
----end 
--if (@viewName='vw_rms_mrgn14' OR @viewName ='')
--begin
--	BEGIN TRY 
--		SET @Q14 = 'SELECT *  FROM OPENQUERY(OracleServer,''SELECT TRDDATE,TMCODE,SPAN_MRGN,EXPOSURE FROM vw_rms_mrgn14  WHERE TRDDATE = '''''+@DATE+''''''')'
--		PRINT @Q14
--		TRUNCATE TABLE RMS_MRGN14

--		INSERT INTO [LivePCM].[dbo].RMS_MRGN14
--		( TRDDATE,TMCODE,SPAN_MRGN,EXPOSURE )
--		EXEC (@Q14)
--	END TRY
--	BEGIN CATCH
--		SET @MSG  = ERROR_MESSAGE() 
--		EXEC Inst_Message 'vw_rms_mrgn14','',@msg
--	END CATCH
--end 



if (@viewName='RMS_CASH_DAY_IN_OUT' OR @viewName ='' OR @viewName='VW_RMS_CASH_DAY_IN_OUT' )
begin
	BEGIN TRY 
		TRUNCATE TABLE RMS_CASH_DAY_IN_OUT
		INSERT INTO [LivePCM].[dbo].RMS_CASH_DAY_IN_OUT
		([APP],[EXCH],TMCODE,[AMT],COLlTYPE,transno,bgfdno)
		SELECT [APP],[EXCH],TMCODE,[AMT],COLlTYPE,transno,bgfdno
		FROM PCM.DBO.RMS_CASH_DAY_IN_OUT
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'RMS_CASH_DAY_IN_OUT','',@msg
	END CATCH
end 


if (@viewName='vw_rms_sc_day_in_out' OR @viewName ='')
begin
	BEGIN TRY 
				TRUNCATE TABLE RMS_SC_DAY_IN_OUT
				INSERT INTO [LivePCM].[dbo].RMS_SC_DAY_IN_OUT
				([APP],[EXCH],[tmcode],SCRIPCODE,ISIN,[QTY],SUBTYPE,transno,SrNo)
				SELECT [APP],[EXCH],[tmcode],SCRIPCODE,ISIN,[QTY],'' SUBTYPE,0 transno,0 SrNo
				FROM PCM.DBO.BEN_VIEW

				--UPDATE RMS_SC_DAY_IN_OUT
				--SET TMCODE  ='0'+LTRIM(RTRIM(TMCODE))
				--WHERE LEN(TMCODE) =4
				--UPDATE RMS_SC_DAY_IN_OUT
				--SET TMCODE  ='00'+LTRIM(RTRIM(TMCODE))
				--WHERE LEN(TMCODE) =3
				--UPDATE RMS_SC_DAY_IN_OUT
				--SET TMCODE  ='000'+LTRIM(RTRIM(TMCODE))
				--WHERE LEN(TMCODE) =2

				--select A.APP,A.[EXCH],A.TMCODE,A.SCRIPCODE,ACTUALHCUT HT 
				--INTO #rms_hc1 
				--from RMS_SC_DAY_IN_OUT a(NOLOCK), RMS_TM_DETAILS B,RMS_SCRIP_BSKT C
				--WHERE A.APP = B.APP
				--AND A.[EXCH] =B.EXCHANGE
				--AND A.TMCODE = B.TMCODE
				--AND B.BASKETCODE =C.BSKTCODE 
				--AND A.APP = c.APP
				--AND A.[EXCH] =c.EXCH
				--AND A.SCRIPCODE = C.SCRIPTCODE

				--UPDATE [RMS_SC_DAY_IN_OUT]
				--SET HAIRCUT = B.HT
				--FROM [RMS_SC_DAY_IN_OUT](NOLOCK) A,#rms_hc1 B
				--WHERE A.APP = B.APP
				--AND A.[EXCH] =B.[EXCH]
				--AND A.TMCODE = B.TMCODE
				--AND A.SCRIPCODE = B.SCRIPCODE

				

				UPDATE [RMS_SC_DAY_IN_OUT]
				SET HAIRCUT = mrgn_rt
				FROM [RMS_SC_DAY_IN_OUT](NOLOCK) A, RMS_HCUT_EXCH B
				WHERE  A.SCRIPCODE = B.symbol
				AND HAIRCUT IS NULL

				UPDATE [RMS_SC_DAY_IN_OUT]
				SET HAIRCUT = HAIRCUT +B.ADDHAIRCUT
				FROM [RMS_SC_DAY_IN_OUT](NOLOCK) A, PCM.DBO.CLIENT_MASTER B(NOLOCK),COMPANY_MASTER C
				WHERE  A.TMCODE = B.CLIENT_ID
				AND B.ADDHAIRCUT IS NULL
				AND B.ADDHAIRCUT > 0
				AND B.COMPANY_CODE = C.COMPANY_CODE
				AND A.APP = C.APP
				AND A.EXCH= C.EXCH



				UPDATE [RMS_SC_DAY_IN_OUT]
				SET RATE = B.PRICE ,VALUE =QTY*(RATE -((RATE*HAIRCUT)/100))
				FROM [RMS_SC_DAY_IN_OUT](NOLOCK) A,LIVE_BACKPRICE B(NOLOCK)
				WHERE A.SCRIPCODE = B.SCRIP_SYMBOL 

				UPDATE [RMS_SC_DAY_IN_OUT]
				SET VALUE =QTY*(RATE -((RATE*HAIRCUT)/100))
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'vw_rms_sc_day_in_out','',@msg
	END CATCH
end 


if (@viewName='VW_RMS_BOD_SEC' OR @viewName ='')
begin
	BEGIN TRY 
		SET @Q4 = 'SELECT  * FROM OPENQUERY(OracleServer,''SELECT APP,EXCH,TRDDATE,TMCODE,SCRIPCODE,ISIN,QTY,Rate from VW_RMS_BOD_SEC   WHERE TRDDATE = '''''+@DATE+''''''')'
		PRINT  @Q4

		Delete RMS_BOD_SEC
		INSERT INTO [LivePCM].[dbo].[RMS_BOD_SEC]
		([APP],[EXCHANGE],[TRADEDATE],[TMCODE],[SCRIPCODE],[ISIN],[QTY],Rate,HAIRCUT,value)
		SELECT [APP],[EXCH],GETDATE(),[tmcode],MAX(SCRIPCODE),ISIN,SUM(QTY),max(Rate),max(HAIRCUT),sum(value)
		FROM PCM.DBO.BEN_VIEW_op
--		WHERE CONVERT(DATETIME,CONVERT(VARCHAR(10),VOUCHER_DATE,103),103)  <CONVERT(DATETIME,@DATE1 ,103)
		GROUP BY APP,EXCH,[TMCODE],[ISIN]



		UPDATE RMS_BOD_SEC
		SET TMCODE  ='0'+LTRIM(RTRIM(TMCODE))
		WHERE LEN(TMCODE) =4 AND EXCHANGE ='NSE'
		UPDATE RMS_BOD_SEC
		SET TMCODE  ='00'+LTRIM(RTRIM(TMCODE))
		WHERE LEN(TMCODE) =3 AND EXCHANGE ='NSE'
		UPDATE RMS_BOD_SEC
		SET TMCODE  ='000'+LTRIM(RTRIM(TMCODE))
		WHERE LEN(TMCODE) =2 AND EXCHANGE ='NSE'

		--select A.APP,A.EXCHANGE,A.TMCODE,A.SCRIPCODE,ACTUALHCUT HT 
		--INTO #rms_hc 
		--from RMS_BOD_SEC a, RMS_TM_DETAILS B,RMS_SCRIP_BSKT C
		--WHERE A.APP = B.APP
		--AND A.EXCHANGE =B.EXCHANGE
		--AND A.TMCODE = B.TMCODE
		--AND B.BASKETCODE =C.BSKTCODE 
		--AND A.APP = c.APP
		--AND A.EXCHANGE =c.EXCH
		--AND A.SCRIPCODE = C.SCRIPTCODE

		--UPDATE [RMS_BOD_SEC]
		--SET HAIRCUT = B.HT
		--FROM [RMS_BOD_SEC] A,#rms_hc B
		--WHERE A.APP = B.APP
		--AND A.EXCHANGE =B.EXCHANGE
		--AND A.TMCODE = B.TMCODE
		--AND A.SCRIPCODE = B.SCRIPCODE

		--UPDATE [RMS_BOD_SEC]
		--SET HAIRCUT = F6
		--FROM [RMS_BOD_SEC] A, TEMPNSEVAR B
		--WHERE  A.SCRIPCODE = B.SCRIP_SYMBOL
		--AND HAIRCUT IS NULL
		
		--UPDATE [RMS_BOD_SEC]
		--set value =QTY*(RATE -((RATE*HAIRCUT)/100))

		--UPDATE [RMS_BOD_SEC]
		--SET RATE = B.PRICE
		--FROM [RMS_BOD_SEC] A,LIVE_BACKPRICE B(NOLOCK)
		--WHERE A.SCRIPCODE = B.SCRIP_SYMBOL 

		DELETE LIVE_BEN_TRANSACTION
		insert into LIVE_BEN_TRANSACTION
		(
			COUNTER_CLIENT_ID,COLLATRAL,CLIENT_ID,ISIN,DEBIT_QUANTITY,NET_QUANTITY,ImportTime,HAIRCUT,VALUE,RATE
		)
		SELECT    EXCHANGE+CASE WHEN APP!='' THEN '_'+APP ELSE '' END,'Y',TMCODE,ISIN,QTY,-1*QTY,GETDATE(),HAIRCUT
		,QTY*(RATE -((RATE*HAIRCUT)/100))
		,RATE
		FROM         RMS_BOD_SEC
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'VW_RMS_BOD_SEC','',@msg
	END CATCH

end 



if (@viewName='RMS_TM_DETAILS' OR @viewName ='')
begin
	BEGIN TRY 
			Truncate table RMS_TM_DETAILS
			INSERT INTO [LivePCM].[dbo].[RMS_TM_DETAILS]
			([APP],[EXCHANGE],[Branch],[Regioncode],[groupcode],[TMCODE],[TMTYPE],[TMSNAME],[TMPANNO],[MOBILENO],[CONTACT1],[CONTACT2],[EMAIL],[BASKETCODE],CASSEC_RATIO,MTM,auto_trd,mrgn_val,coll_val)
			SELECT [APP],[EXCHANGE],[Branch],[Regioncode],[groupcode],[TMCODE],[TMTYPE],[TMSNAME],[TMPANNO],[MOBILENO],[CONTACT1],[CONTACT2],[EMAIL],[BASKETCODE],CASSEC_RATIO,MTM,auto_trd,mrgn_val,coll_val
			FROM PCM.DBO.RMS_TM_DETAILS


			DELETE LIVE_CLIENT_MASTER  
			UPDATE [RMS_TM_DETAILS]
			SET TMCODE  ='0'+LTRIM(RTRIM(TMCODE))
			WHERE LEN(TMCODE) =4 AND EXCHANGE ='NSE'
			UPDATE [RMS_TM_DETAILS]
			SET TMCODE  ='00'+LTRIM(RTRIM(TMCODE))
			WHERE LEN(TMCODE) =3 AND EXCHANGE ='NSE'
			UPDATE [RMS_TM_DETAILS]
			SET TMCODE  ='000'+LTRIM(RTRIM(TMCODE))
			WHERE LEN(TMCODE) =2 AND EXCHANGE ='NSE'

			INSERT INTO LIVE_CLIENT_MASTER
			(COMPANY_CODE,CLIENT_ID,CLIENT_NAME,BRANCH_CODE,[Regioncode],[groupcode],[CLIENT_NATURE])
			SELECT EXCHANGE+CASE WHEN APP !='' THEN '_' ELSE '' END +APP,TMCODE,TMSname,isnull([Branch],''),isnull([Regioncode],''),isnull([groupcode],''),isnull([TMTYPE],'')
			FROM [RMS_TM_DETAILS]
			WHERE 1=1--EXCHANGE ='NSE' AND APP ='FNO' 
			AND TMCODE IS NOT NULL
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'RMS_TM_DETAILS','',@msg
	END CATCH
end 
if (@viewName='VW_RMS_BOD_CASH' OR @viewName ='')
begin
	BEGIN TRY 
		SET @Q3 = '
				SELECT * FROM OPENQUERY(OracleServer,'' SELECT  APP,EXCH,TRDDATE,TMCODE,TOTCASH,CASH,BG,FD FROM VW_RMS_BOD_CASH WHERE TRDDATE = '''''+@DATE+''''''')'
				PRINT @Q3

			Delete [RMS_BOD_MARGIN]
			INSERT INTO [LivePCM].[dbo].[RMS_BOD_MARGIN]
			([APP],[EXCHANGE],[TRDDATE],[TMCODE],[TOTCASH],CASH,BG,FD)
			SELECT APP,EXCH,GETDATE(),TMCODE
			,SUM(AMT ) [TOTCASH]
			,SUM(CASE WHEN COLLTYPE='CASH' THEN AMT ELSE 0 END ) CASH
			,SUM(CASE WHEN COLLTYPE='BG' THEN AMT ELSE 0 END ) BG
			,SUM(CASE WHEN COLLTYPE='FD' THEN AMT ELSE 0 END ) FD
			FROM PCM.DBO.RMS_BOD_MARGIN 
			GROUP BY APP,EXCH,TMCODE


	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'RMS_BOD_MARGIN','',@msg
	END CATCH
end 

if (@viewName='CM_MASTER' OR @viewName ='')
begin
	BEGIN TRY 
		DELETE CM_MASTER
		INSERT INTO CM_MASTER
		(APP,EXCH,Client_Id,CLIENT_ID2)
		SELECT  APP,EXCH,Client_Id,CLIENT_ID2 
		FROM  PCM.DBO.CM_MASTER A,COMPANY_MASTER B
		WHERE A.COCD = B.COMPANY_CODE

	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'VW_RMS_CROSS_MRGN','',@msg
	END CATCH
end 

if (@viewName='VW_RMS_OPEN_POSN' OR @viewName ='')
begin
BEGIN TRY 
	
	DELETE TRADE from TRADE(nolock) where Backoffice='Y'
	DELETE TRADE FROM TRADE(NOLOCK) WHERE TRADE_DATE !=  CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),103),103)
	INSERT	TRADE
	(
		COMPANY_CODE,TRADE_NUMBER,CLIENT_ID,REVERSE_CLIENT_ID
		,SCRIP_SYMBOL,SCRIP_NAME,TRADE_DATE,TRADE_DATETIME
		,EXPIRY_DATE,BUY_SALE,MKT_TYPE,QUANTITY
		,PRICE_PREMIUM,ORDER_NUMBER,ORDER_DATETIME,USER_ID,SETTLEMENT_NO,BILL_SETTLEMENT_NO,VALIDITY_FLAG,CUSTODIAN_CODE,CLIENT_ID2
		,BILL_DATE,INSTRUMENT_TYPE
		,OPTION_TYPE,STRIKE_PRICE,LOT_SIZE,IS_MANUAL_BROKERAGE,Backoffice
	)
	SELECT COMPANY_CODE,TRADE_NUMBER,CLIENT_ID,REVERSE_CLIENT_ID
		,SCRIP_SYMBOL,SCRIP_NAME,TRADE_DATE,TRADE_DATETIME
		,EXPIRY_DATE,BUY_SALE,MKT_TYPE,QUANTITY
		,PRICE_PREMIUM,ORDER_NUMBER,ORDER_DATETIME,USER_ID,SETTLEMENT_NO,0 BILL_SETTLEMENT_NO,VALIDITY_FLAG,CUSTODIAN_CODE,CLIENT_ID2
		,BILL_DATE,INSTRUMENT_TYPE
		,OPTION_TYPE,STRIKE_PRICE,LOT_SIZE,'N' IS_MANUAL_BROKERAGE,Backoffice
	from PCM.DBO.LIVE_TRADE
	where Backoffice ='y'
	
	update TRADE
	set CLIENT_ID2 =CLIENT_ID
	where CLIENT_ID2='PROPRIETARY'


 
	DELETE TRADE 
	FROM TRADE(NOLOCK) A FULL OUTER JOIN  [RMS_TM_DETAILS] B
	ON A.COMPANY_CODE= EXCHANGE+CASE WHEN APP!='' THEN '_'+APP ELSE '' END
	AND A.CLIENT_ID = B.TMCODE
	WHERE B.TMCODE IS NULL
	AND BACKOFFICE ='Y'

	UPDATE TRADE
	SET CLIENT_ID2 =CLIENT_ID
	FROM TRADE(NOLOCK) X
	WHERE CLIENT_ID IN( SELECT TMCODE FROM [RMS_TM_DETAILS] Y WHERE TMTYPE ='CP' AND EXCHANGE+CASE WHEN APP!='' THEN '_'+APP ELSE '' END = COMPANY_CODE )
	AND CLIENT_ID ! =CLIENT_ID2

	DELETE LIVE_BackPrice
	WHERE exchange !='CASH' 
	and INSTRUMENTTYPE LIKE 'FUT%'
	
	INSERT	LIVE_BackPrice
	(
		exchange, SCRIP_SYMBOL, SCRIP_NAME, isin, Price, FILEDATE, ImportTime,INSTRUMENTTYPE
	)	
	SELECT DISTINCT  COMPANY_CODE,A.SCRIP_SYMBOL,SCRIP_NAME,'' ISIN, PRICE_PREMIUM,GETDATE(),GETDATE(),INSTRUMENT_TYPE
	FROM TRADE A(nolock)
	WHERE	BACKOFFICE='Y'
	AND PRICE_PREMIUM > 0 
	AND INSTRUMENT_TYPE LIKE 'FUT%'

	select exchange,token,PRICE,SCRIP_SYMBOL
	INTO #LIVE_BackPrice
	from LIVE_BackPrice A,SCRIP_MASTER B
	WHERE A.SCRIP_SYMBOL = B.FILLER
	AND A.exchange !='CASH'
	AND DATEPART(HH,GETDATE()) <9 
	UPDATE LIVE_Price
	SET PRICE = B.PRICE,ImportTime=GETDATE()
	FROM LIVE_Price (NOLOCK) A,#LIVE_BackPrice B
	WHERE A.TOKEN = B.token
	AND DATEPART(HH,GETDATE()) <9 
	
	UPDATE TRADE
	SET PRICE_PREMIUM =0 
	FROM TRADE(NOLOCK)
	WHERE BACKOFFICE='Y' AND INSTRUMENT_TYPE LIKE 'OPT%' 


	exec [LIVEMESSAGE]

	if(select count(1) from COMPANY_MASTER where COMPANY_CODE ='CD_NSE' ) =1
	begin
			EXEC SPANCAL 'Y'  --NSE_FNO
			EXEC [EXPOSUREMARGIN]
	END
	if(select count(1) from COMPANY_MASTER where COMPANY_CODE ='CD_NSE' ) =1
	begin
		EXEC [LIVE_SPANCAL_ALL] 'CD_NSE', 'Y' 
	END
	if(select count(1) from COMPANY_MASTER where COMPANY_CODE ='CD_MCX' ) =1
	begin
				BEGIN TRY
						EXEC [LIVE_SPANCAL_ALL] 'CD_MCX', 'Y' 
				END TRY
				BEGIN CATCH
					SET @MSG  = ERROR_MESSAGE() 
					EXEC Inst_Message 'CDMCX Span Margin','',@msg
				END CATCH
	END	
					if(select count(1) from COMPANY_MASTER where COMPANY_CODE ='NCDEX' ) =1
					begin
						BEGIN TRY
							EXEC [LIVE_SPANCAL_ALL] 'NCDEX', 'Y' 
						END TRY
						BEGIN CATCH
							SET @MSG  = ERROR_MESSAGE() 
							EXEC Inst_Message 'NCDEX Span Margin','',@msg
						END CATCH
					end	

					if(select count(1) from COMPANY_MASTER where COMPANY_CODE ='MCX' ) =1
					begin
								BEGIN TRY
									EXEC [LIVE_SPANCAL_ALL] 'MCX', 'Y' 
								END TRY
								BEGIN CATCH
									SET @MSG  = ERROR_MESSAGE() 
									EXEC Inst_Message 'MCX Span Margin','',@msg
								END CATCH
								
					END 
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'VW_RMS_OPEN_POSN','',@msg
	END CATCH
end

if (@viewName='VW_RMS_MRGN' OR @viewName ='')
begin
	begin try
	
		TRUNCATE TABLE VW_RMS_MRGN
		
		INSERT INTO VW_RMS_MRGN
		(APP, EXCH, TRDDATE, TMCODE, SPAN_MRGN, BUY_PREM, EXPOSURE)     
		SELECT APP, EXCH, TRDDATE, TMCODE, SPAN_MRGN, BUY_PREM, EXPOSURE
		FROM PCM.DBO.VW_RMS_MRGN 
		WHERE TRDDATE = CONVERT(DATETIME,@DATE,103)

		DELETE MG12_T1
		INSERT INTO MG12_T1
		(MARGIN_DATE,CLIENT_ID,NET_BUY_PREMIUM)
		SELECT TRDDATE, TMCODE, BUY_PREM
		FROM PCM.DBO.VW_RMS_MRGN 
		WHERE TRDDATE = CONVERT(DATETIME,@DATE,103)
		AND COMPANY_CODE = 'NSE_FNO'
		AND BUY_PREM !=0


		DELETE MG12_T2
		INSERT INTO MG12_T2
		(MARGIN_DATE,CLIENT_ID,NET_BUY_PREMIUM)
		SELECT TRDDATE, TMCODE, BUY_PREM
		FROM PCM.DBO.VW_RMS_MRGN 
		WHERE TRDDATE != CONVERT(DATETIME,@DATE,103)
		AND TRDDATE  IN(SELECT MAX(TRDDATE ) FROM PCM.DBO.VW_RMS_MRGN WHERE TRDDATE != CONVERT(DATETIME,@DATE,103) AND COMPANY_CODE = 'NSE_FNO')
		AND COMPANY_CODE = 'NSE_FNO'
		AND BUY_PREM !=0

	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'VW_RMS_MRGN','',@msg
	END CATCH
END

if (@viewName='LIVE_Exposure' OR @viewName ='')
begin

begin try
	
		truncate table LIVE_Exposure

		INSERT INTO LIVE_Exposure
		(Sr_No,Scrip_Code,Exposure_Price,Exposure_months)
		select sR_NO,SCRIP_CODE,Exposure_Price,GETDATE() from PCM.DBO.[Exposure_Tab]

		insert into LIVE_Exposure
		(Sr_No,Scrip_Code,Exposure_Price,Exposure_months)
		values(1,'NIFTY',3,GETDATE())
				
		insert into LIVE_Exposure
		(Sr_No,Scrip_Code,Exposure_Price,Exposure_months)
		values(2,'MINIFTY',3,GETDATE())
				
		insert into LIVE_Exposure
		(Sr_No,Scrip_Code,Exposure_Price,Exposure_months)
		values(3,'BANKNIFTY',3,GETDATE())
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'LIVE_Exposure','',@msg
	END CATCH
END

if (@viewName='VW_RMS_PENALTY' OR @viewName ='')
begin
	begin try
			SET @Q17 = 'SELECT APP, EXCHANGE, TRDDATE, TM_CODE, CLNT_CODE, SYMBOL, CONST_QTY, VIOLATION_QTY 
						  FROM OPENQUERY(OracleServer,''SELECT A.* FROM VW_RMS_PENALTY A ,(SELECT APP,EXCHANGE,MAX(TRDDATE) TRDDATE FROM  VW_RMS_PENALTY GROUP BY APP,EXCHANGE ) B
												WHERE A.TRDDATE =  B.TRDDATE
												AND A.APP = B.APP AND A.EXCHANGE =B.EXCHANGE'')'
			PRINT @Q17
			DELETE VW_RMS_PENALTY
			INSERT INTO VW_RMS_PENALTY
			(APP, EXCHANGE, TRDDATE, TM_CODE, CLNT_CODE, SYMBOL, CONST_QTY, VIOLATION_QTY)
			SELECT APP, EXCHANGE, TRDDATE, TM_CODE, CLNT_CODE, SYMBOL, CONST_QTY, VIOLATION_QTY FROM PCM.DBO.VW_RMS_PENALTY A,COMPANY_MASTER B
			WHERE A.COCD = B.COMPANY_CODE
			AND TRDDATE = CONVERT(DATETIME,@date,103)
			
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'VW_RMS_PENALTY','',@msg
	END CATCH

end 

if (@viewName='MTMCLOSINGPRICE' OR @viewName ='')
begin
	begin try
			
			--DELETE VW_RMS_BHAV_COPY
			--INSERT INTO VW_RMS_BHAV_COPY
			--(APP, EXCHANGE, TRDDATE, INSTRTYPE, SYMBOL, EXPRDATE, STRKPRICE, OPTIONTYPE, SETTPRICE)
			--EXEC (@Q17)
			
			DELETE LIVE_BackPrice
			WHERE exchange !='CASH' 
			and INSTRUMENTTYPE LIKE 'OPT%'
			INSERT	LIVE_BackPrice
			(
				exchange, SCRIP_SYMBOL, SCRIP_NAME, isin, Price, FILEDATE, ImportTime,INSTRUMENTTYPE
			)	
			SELECT A.COMPANY_CODE,SCRIP_SYMBOL,SCRIP_NAME,'',MTM_PRICE,GETDATE(),GETDATE(),INSTRUMENT_TYPE
			FROM PCM.DBO.MTMCLOSINGPRICE A,COMPANY_MASTER B
			WHERE A.COMPANY_CODE = B.COMPANY_CODE
			AND MARKET_DATE = CONVERT(DATETIME,@date,103)
	END TRY
	BEGIN CATCH
		SET @MSG  = ERROR_MESSAGE() 
		EXEC Inst_Message 'VW_RMS_BHAV_COPY','',@msg
	END CATCH
end 
--if (@viewName='vw_rms_posn_limit' OR @viewName ='')
--begin
--begin try
--	SET @Q15 = 'SELECT SYMBOL,MARKETWIDE_LIMIT,TM_LIMIT,OVERALL_LIMIT
--	FROM PCM.DBO.RMS_POSN_LIMIT
--	where trade_date in(select max(trade_date) from PCM.DBO.RMS_POSN_LIMIT) '
--	PRINT @Q15
--	TRUNCATE TABLE RMS_POSN_LIMIT
--	INSERT INTO [LivePCM].[dbo].RMS_POSN_LIMIT
--	( SYMBOL,MARKETWIDE_LIMIT,TM_LIMIT,OVERALL_LIMIT )
--	exec(@Q15)
--	END TRY
--BEGIN CATCH
--		EXEC Inst_Message 'vw_rms_posn_limit','',@msg
--	END CATCH
--end 
--if (@viewName='vw_permissable_limit' OR @viewName ='')
--begin
--begin try
--	SET @Q16 = 'SELECT SYMBOL,MARKETWIDE_LIMIT,TM_LIMIT,OVERALL_LIMIT
--	FROM PCM.DBO.RMS_PERMISSABLE_LIMIT
--	where trade_date in(select max(trade_date) from PCM.DBO.RMS_PERMISSABLE_LIMIT)'
--	PRINT @Q16
--	TRUNCATE TABLE RMS_PERMISSABLE_LIMIT

--	INSERT INTO [LivePCM].[dbo].RMS_PERMISSABLE_LIMIT
--	( SRNO,SYMBOL,ISIN,OVERALL_LIMIT,MEMBERWAIE_LIMIT )
--	EXEC (@Q16)
	
--	END TRY
--	BEGIN CATCH
--		SET @MSG  = ERROR_MESSAGE() 
--		EXEC Inst_Message 'vw_permissable_limit','',@msg
--	END CATCH

--end 



--if (@viewName='vw_rms_clinet_posn_limit' OR @viewName ='')
--begin
--begin try
--	SET @Q17 = 'SELECT *  FROM pcm.dbo.clinet_posn_limit WHERE TRADEdATE IN(SELECT MAX(TRADEdATE) FROM pcm.dbo.clinet_posn_limit)'
--	PRINT @Q17
--	TRUNCATE TABLE RMS_CLIENT_POSN_LIMIT

--	INSERT INTO [LivePCM].[dbo].RMS_CLIENT_POSN_LIMIT
--	(  TRDDATE,SYMBOL,QTY  )
--	EXEC (@Q17)
--	END TRY
--	BEGIN CATCH
--		SET @MSG  = ERROR_MESSAGE() 
--		EXEC Inst_Message 'vw_rms_clinet_posn_limit','',@msg
--	END CATCH

--	Begin try
--	SET @Q4 = 'SELECT SYMBOL,CLIENT_LIMIT  FROM pcm.dbo.clinet_posn_limit WHERE TRADEdATE IN(SELECT MAX(TRADEdATE) FROM pcm.dbo.clinet_posn_limit)'
--	PRINT  @Q4
--	TRUNCATE TABLE MWP
--	INSERT INTO MWP
--	(SYMBOL,QTY)     
--	EXEC (@Q4)
--	END TRY
--	BEGIN CATCH
--		SET @MSG  = ERROR_MESSAGE() 
--		EXEC Inst_Message 'VW_RMS_CLINET_POSN_LIMIT','','',@msg
--	END CATCH


--end

if @viewName !=''
begin
	update Live_CMTable
	set   Last_Process_DateTime=getdate()
	Where @viewName= viewname
End
if @viewName = ''
begin
	set @viewName  =null
end
update Live_CMTable
set   Last_Process_DateTime=getdate()
where VIEWNAME = isnull(@viewName,VIEWNAME)
insert into live_Repli_Backup
(LAST_PROCESS_DATETIME,VIEWNAME)
SELECT  getdate(),VIEWNAME
FROM  Live_CMTable
where VIEWNAME = isnull(@viewName,VIEWNAME)
and @viewName not in ('VW_RMS_CASH_DAY_IN_OUT','vw_rms_sc_day_in_out','VW_RMS_LIVE_LIMIT','VW_RMS_ENTRY_DTLS')

